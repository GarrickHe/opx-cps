#!/bin/bash

filen=$1
target_file=$2
resource_file=$3
union_name=db_acl_qualifier_mask_t

union_fields1=$(cat $resource_file | grep -v "_e\;" | grep \\\} | tr '}' ' '  | tr ';' ' '  | cut -f2 -d ' ')

union_fields2=$(cat $resource_file | grep -v "_e\;" | grep \\mask_t\; | tr '}' ' ' | sed 's/typedef//' | sed -n -e 's/^.*valmask_t//p' | tr ';' ' ' )

union_fields3=$(cat $resource_file | grep -v "_e\;" | grep \\mask_t\; | tr '}' ' ' | sed 's/typedef//' | sed -n -e 's/^.*valmask[0-9]_t//p' | tr ';' ' ' )

union_fields4=$(cat $resource_file | grep -v "_e\;" |grep \\mask_t\; | tr '}' ' ' | sed 's/typedef//' | sed -n -e 's/^.*valmask[0-9][0-9]_t//p' | tr ';' ' ' )

union_fields5=$(cat $resource_file | grep -v "valmask" | grep "typedef" | grep -v "enum" | grep -v "struct" | awk '{print $3}' | tr ';' ' ')

real_union_fields=$union_fields1$union_fields2$union_fields3$union_fields4$union_fields5

auto_header=$(echo "${target_file^^}")

echo "
/* DO NOT EDIT THIS FILE!
 * This file is auto-generated.
 * Edits to this file will be lost when it is regenerated.
 */
#ifndef __${auto_header}__
#define __${auto_header}__

typedef union {
" > $filen

for i in $real_union_fields ; do
    fieldn=$(echo $i | sed -e 's/db_acl_//g' | sed -e 's/_t//g')
    echo "  $i ${fieldn};" >> $filen
done

echo "
} $union_name;

#endif" >> $filen
